{% load static %}

<div class="card">
  <div class="card-header d-flex">
    <h4>Объекты ТО</h4>

    <div class="col d-flex justify-content-end align-items-center">
      <div class="form-check form-switch me-3">
        <input class="form-check-input" type="checkbox" id="sortToggle" 
              onclick="toggleSortMenu()">
        <label class="form-check-label" for="sortToggle">
          Сортировка
        </label>
      </div>

      {% if user.is_superuser %}
      <button type="button" class="btn btn-primary"
              onclick="loadModalForm('{% url 'object_add' %}', 'Добавить объект')">
        Добавить
      </button>
      {% endif %}
    </div>
  </div>

  {% load custom_filters %}
    <!-- Контейнер для меню сортировки (изначально скрыт) -->
  <div id="sortMenuContainer">
    {% include 'sort_object.html' %}
  </div>

  <div class="card-body" style="padding: 0px; min-height: 100px !important;">
    <table class="table-hover" style="width: 100%;">
      <tr style="background-color: #de4c15; color: white;">
          {% comment %} <th>ID</th> {% endcomment %}
          <th class="delete" style="text-align: center;">Заказчик</th>
          <th style="text-align: center;">Адрес</th>
          <th style="text-align: center;">Телефон</th>
          <th></th>
      </tr>

      {% for object in objects %}
      {% with service_record=service_records|get_item:object.id %}


      <tr style="background-color: 
      {% if service_record %}
        {% if service_record.result == 0 %} #00800063
        {% elif service_record.result == 1 %} #ffff0063
        {% elif service_record.result == 2 %} #ff000063
        {% else %} transparent
        {% endif %}
      {% else %} #80808063
      {% endif %};">
      
          {% comment %} <td>{{ object.id }}</td> {% endcomment %}
          <td class="delete" style="text-align: center;">{{ object.customer }}</td>
          <td style="text-align: center;" style="text-align: center;">
            <a href="https://yandex.ru/maps/?text={{ object.address|urlencode }}" target="_blank" style="text-decoration: none; color: inherit;">
              <img src="{% static 'ico/geo-alt.svg' %}" alt="phone" class="delete" style="width: 16px; height: 16px; vertical-align: middle;">
                {{ object.address }}
            </a>
          </td>
          <td style="text-align: center;">
            <a href="tel:{{ object.phone }}" style="text-decoration: none; color: inherit; text-wrap-mode: nowrap;">
              <img src="{% static 'ico/telephone.svg' %}" alt="phone" class="delete" style="width: 16px; height: 16px; vertical-align: middle;">
              {{ object.phone }}<br>
            </a>
            {% comment %} {{ object.name }} {% endcomment %}
          </td>

          <td style="text-align: end;">
            <div class="btn-group" style="gap: 2px;">

              {% comment %} {% if user.is_superuser %} {% endcomment %}
              {% if user.is_superuser or user in object.accessuser_set.all %}
              <button onclick="loadModalForm('{% url 'object_edit' pk=object.id %}', 'Редактировать объект')" 
                      class="btn btn-secondary delete">&#9998;</button>
              {% endif %}

              <button onclick="loadModalForm('{% url 'avr_add' pk=object.id %}', 'Добавление АВР')" 
                class="btn btn-success">АВР</button>

              <button class="btn btn-primary" 
                onclick="loadModalForm('{% url 'service_add' object_id=object.id %}', 'Добавление обслуживания', this)" 
                data-last-color="
                {% if service_record %}
                  {% if service_record.result == 0 %}#d4edda
                  {% elif service_record.result == 1 %}#fff3cd
                  {% elif service_record.result == 2 %}#f8d7da
                  {% else %}#ffffff{% endif %}
                {% else %}#808080{% endif %}">
                ТО
              </button>

              {% if user.is_superuser %}
              <button onclick="confirmDelete('{% url 'object_delete' pk=object.id %}', '{{ object.id }}')" 
                      class="btn btn-danger delete" style="padding: 5px 15px;">
                <strong>Х</strong>
              </button>
              {% endif %}

            </div>
          </td>
      </tr>
      {% endwith %}
      {% empty %}
          <tr>
          <td colspan="4" style="text-align: center; padding: 20px;">
              {% if user.is_superuser %}
                  Нет объектов для отображения
              {% else %}
                  У вас нет доступа к объектам или объекты не назначены
              {% endif %}
          </td>
        </tr>
      {% endfor %}
      
      <!-- Строка с суммой -->
      <tr style="background-color: #f0f0f0; font-weight: bold;">
        <td colspan="2"></td>
        <td style="text-align: right; padding: 0px 10px;">
          Итого: {{ objects|length }}
        </td>
        <td class="delete"></td>
      </tr>
  </table>
</div>
</div>

<script>
function toggleSortMenu() {
    const sortMenu = document.getElementById('sortMenuContainer');
    const toggle = document.getElementById('sortToggle');
    
    if (toggle.checked) {
        sortMenu.classList.add('show');
    } else {
        sortMenu.classList.remove('show');
    }
}

// Опционально: функция для сохранения состояния переключателя
function saveToggleState() {
    const toggle = document.getElementById('sortToggle');
    localStorage.setItem('sortMenuVisible', toggle.checked);
}

function loadToggleState() {
    const savedState = localStorage.getItem('sortMenuVisible');
    const toggle = document.getElementById('sortToggle');
    const sortMenu = document.getElementById('sortMenuContainer');
    
    if (savedState === 'true') {
        toggle.checked = true;
        // Небольшая задержка для корректной анимации при загрузке
        setTimeout(() => {
            sortMenu.classList.add('show');
        }, 10);
    }
}

// Загружаем состояние при загрузке страницы
document.addEventListener('DOMContentLoaded', loadToggleState);

// Сохраняем состояние при изменении
document.getElementById('sortToggle').addEventListener('change', saveToggleState);
</script>