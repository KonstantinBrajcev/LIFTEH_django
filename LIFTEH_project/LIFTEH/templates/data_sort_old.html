{% load static %}
{% load object_plural %}
{% load custom_filters %}

<style>
.accordion-arrow {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 16px;
    height: 16px;
    transition: transform 0.3s ease;
    color: #6c757d;
}

.accordion-arrow.rotated {
    transform: rotate(90deg);
    color: #0d6efd;
}

.accordion-header:hover .accordion-arrow {
    color: #495057;
}

.accordion-arrow svg {
    width: 100%;
    height: 100%;
    stroke: currentColor;
}

/* Стили для плавной анимации выпадающего меню */
.customer-group-content {
    max-height: 0;
    overflow: hidden;
    opacity: 0;
    transition: max-height 0.4s ease, opacity 0.3s ease;
    display: block !important;
}

.customer-group-content.expanded {
    max-height: 5000px;
    opacity: 1;
}

/* Плавное появление строк внутри аккордеона */
.customer-group-content tr {
    transform: translateY(-10px);
    opacity: 0;
    transition: transform 0.3s ease, opacity 0.3s ease;
}

.customer-group-content.expanded tr {
    transform: translateY(0);
    opacity: 1;
}

.table-hover {
    width: 100% !important;
    table-layout: auto; 
}

.customer-group-content {
    width: 100%;
}

.customer-group-content tr {
    display: table;
    width: 100%;
}
</style>
<div class="card">
  <div class="card-header d-flex">
    <h3 style="margin: 0px; align-content: center;">Объекты ТО</h3>
    <div class="col d-flex justify-content-end align-items-center">

      <!-- Переключатель для управления всеми группами -->
      <div class="form-check form-switch me-3">
        <input class="form-check-input" type="checkbox" id="groupToggle" 
              onchange="toggleAllGroups(this.checked)">
        <label class="form-check-label" for="groupToggle">
          Развернуть
        </label>
      </div>

      {% if user.is_superuser %}
      <button type="button" class="btn btn-primary"
              onclick="loadModalForm('{% url 'object_add' %}', 'Добавить объект')">
        Добавить
      </button>
      {% endif %}
    </div>
  </div>

  <div class="content-wrapper" id="mainContent">
    <div class="card-body" style="padding: 0px; min-height: 100px !important;">
      
      {% for group in grouped_objects %}
      <div class="customer-group">
        
        <!-- Заголовок группы -->
        <div class="customer-group-header accordion-header" 
             style="background-color: #e9ecef; cursor: pointer; padding: 5px 15px;"
             onclick="toggleCustomerGroup({{ forloop.counter }})"
             data-group-id="{{ forloop.counter }}">
          
          <div style="display: flex; justify-content: space-between; align-items: center; font-weight: bold;">
            <div>{{ group.customer }}</div>
            <div style="display: flex; align-items: center; gap: 8px;">
              <span class="badge bg-secondary">{{ group.objects|length }} {{ group.objects|length|object_plural }}</span>
              <span class="accordion-arrow">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                  <path d="M6 4L10 8L6 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </span>
            </div>
          </div>
          
        </div>
        
        <!-- Содержимое группы (изначально скрыто) -->
        <div id="group-{{ forloop.counter }}" class="customer-group-content">
          <table style="width: 100%;">
            <tbody>
            {% for object in group.objects %}
            {% with service_record=service_records|get_item:object.id %}
            <tr style="background-color: 
              {% if service_record %}
                {% if service_record.result == 0 %} #00800063
                {% elif service_record.result == 1 %} #ffff0063
                {% elif service_record.result == 2 %} #ff000063
                {% else %} transparent
                {% endif %}
              {% else %} #80808063
              {% endif %};">

                <td style="text-align: left; padding: 0px 5px 0px 5px; width: 40%">
                  <a href="https://yandex.ru/maps/?text={{ object.address|urlencode }}" target="_blank" style="text-decoration: none; color: inherit;">
                    <img src="{% static 'ico/geo-alt.svg' %}" alt="phone" class="delete" style="width: 16px; height: 16px; vertical-align: middle;">
                    {{ object.address }}
                  </a>
                </td>

                <td class="delete" style="text-align: center; padding-left: 1vw; width: 30%;">
                  {{ object.model }}
                </td>

                <td style="text-align: center; padding: 0px 5px 0px 5px; width: 20%;">
                  <a href="tel:{{ object.phone }}" style="text-decoration: none; color: inherit; text-wrap-mode: nowrap;">
                    <img src="{% static 'ico/telephone.svg' %}" alt="phone" class="delete" style="width: 16px; height: 16px; vertical-align: middle;">
                    {{ object.phone }}<br>
                  </a>
                </td>

                <td style="text-align: end;">
                  <div class="btn-group" style="gap: 2px;">

                    {% if user.is_superuser %}
                    <button onclick="loadModalForm('{% url 'object_edit' pk=object.id %}', 'Редактировать объект')" 
                            class="btn btn-secondary delete">&#9998;</button>
                    {% endif %}

                    <button onclick="loadModalForm('{% url 'avr_add' pk=object.id %}', 'Добавление АВР')" 
                      class="btn btn-success">АВР</button>

                    <button class="btn btn-primary" 
                      onclick="loadModalForm('{% url 'service_add' object_id=object.id %}', 'Добавление обслуживания', this)" 
                      data-last-color="
                      {% if service_record %}
                        {% if service_record.result == 0 %}#d4edda
                        {% elif service_record.result == 1 %}#fff3cd
                        {% elif service_record.result == 2 %}#f8d7da
                        {% else %}#ffffff{% endif %}
                      {% else %}#808080{% endif %}">
                      ТО
                    </button>

                    {% if user.is_superuser %}
                    <button onclick="confirmDelete('{% url 'object_delete' pk=object.id %}', '{{ object.id }}')" 
                            class="btn btn-danger delete" style="padding: 5px 15px;">
                      <strong>Х</strong>
                    </button>
                    {% endif %}

                  </div>
                </td>

            </tr>
            {% endwith %}
            {% endfor %}
            </tbody>
          </table>
        </div>
        
      </div>

      {% empty %}
      <div style="text-align: center; padding: 20px;">
        {% if user.is_superuser %}
        Нет объектов для отображения
        {% else %}
        У вас нет доступа к объектам или объекты не назначены
        {% endif %}
      </div>
      {% endfor %}
      
    </div>

      <div style="justify-self: end; padding: 0 10px 0px 10px">
          В 
          {% if current_month == 1 %}январе
          {% elif current_month == 2 %}феврале
          {% elif current_month == 3 %}марте
          {% elif current_month == 4 %}апреле
          {% elif current_month == 5 %}мае
          {% elif current_month == 6 %}июне
          {% elif current_month == 7 %}июле
          {% elif current_month == 8 %}августе
          {% elif current_month == 9 %}сентябре
          {% elif current_month == 10 %}октябре
          {% elif current_month == 11 %}ноябре
          {% elif current_month == 12 %}декабре
          {% endif %}: 
          Заказчиков: {{ grouped_objects|length }}, 
          Обьектов: {{ objects|length }} 
    </div>

  </div>
</div>
<script>
// Функция для переключения состояния группы с анимацией
function toggleCustomerGroup(groupId) {
    const groupContent = document.getElementById(`group-${groupId}`);
    const groupHeader = document.querySelector(`[data-group-id="${groupId}"]`);
    const arrow = groupHeader.querySelector('.accordion-arrow');
    
    if (!groupContent.classList.contains('expanded')) {
        // Разворачиваем группу
        expandGroup(groupContent, arrow);
    } else {
        // Сворачиваем группу
        collapseGroup(groupContent, arrow);
    }
}

// Функция разворачивания группы
function expandGroup(groupContent, arrow) {
    groupContent.classList.add('expanded');
    arrow.classList.add('rotated');
}

// Функция сворачивания группы
function collapseGroup(groupContent, arrow) {
    groupContent.classList.remove('expanded');
    arrow.classList.remove('rotated');
}

// Функция для управления всеми группами через переключатель
function toggleAllGroups(isChecked) {
    if (isChecked) {
        // Развернуть все группы
        document.querySelectorAll('.customer-group-content').forEach(content => {
            const arrow = content.previousElementSibling.querySelector('.accordion-arrow');
            expandGroup(content, arrow);
        });
    } else {
        // Свернуть все группы
        document.querySelectorAll('.customer-group-content').forEach(content => {
            const arrow = content.previousElementSibling.querySelector('.accordion-arrow');
            collapseGroup(content, arrow);
        });
    }
}

// Инициализация состояния при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    const groupToggle = document.getElementById('groupToggle');
    if (groupToggle) {
        groupToggle.checked = false;
    }
    
    // Убедимся, что все группы изначально свернуты
    document.querySelectorAll('.customer-group-content').forEach(content => {
        content.classList.remove('expanded');
    });
});
</script>

<script src={% static 'js/object.js' %}></script>