{% load static %}

{% comment %} <style>
.table th {
    font-weight: 600;
    font-size: 14px;
}

.table td {
    vertical-align: middle;
    font-size: 14px;
}

.badge {
    font-size: 12px;
    padding: 4px 8px;
}

.btn-group-sm .btn {
    padding: 2px 8px;
    font-size: 14px;
}

.card-title {
    font-size: 14px;
    margin-bottom: 5px;
}

.card-text {
    font-size: 24px;
    font-weight: bold;
}
</style>
 {% endcomment %}

<div class="card">
  <div class="card-header d-flex">
    <h3 style="margin: 0px; align-content: center;">–î–æ–≥–æ–≤–æ—Ä—ã</h3>

    {% if user.is_superuser %}
      <div class="col d-flex justify-content-end align-items-center">
        <button type="button" class="btn btn-primary" 
          onclick="loadModalForm('{% url 'dogovor_add' %}', '–î–æ–±–∞–≤–∏—Ç—å –¥–æ–≥–æ–≤–æ—Ä')">
            –î–æ–±–∞–≤–∏—Ç—å
        </button>
      </div>
    {% endif %}
  </div>

  <div class="card-body" style="padding: 0px; min-height: 50px;">
    <table class="table-hover" style="width: 100%;">
      <thead class="table-light">
        <tr style="background-color: #de4c15; color: white;">
          <th style="text-align: center;">‚Ññ</th>
          <th style="text-align: center;">–ó–∞–∫–∞–∑—á–∏–∫</th>
          <th style="text-align: center;">–î–∞—Ç–∞</th>
          <th style="text-align: center;">–§–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏–µ</th>
          <th style="text-align: center;">–õ–æ–Ω–≥–∏—Ä–æ–≤–∞–Ω–∏–µ</th>
          <th style="text-align: center;">–°—Ç–∞—Ç—É—Å</th>
          <th style="text-align: center;">–û–±—ä–µ–∫—Ç–æ–≤</th>
          <th style="text-align: center;">–î–µ–π—Å—Ç–≤–∏—è</th>
        </tr>
      </thead>
      <tbody>
        {% for dogovor in dogovors %}

        <!-- –î–æ–±–∞–≤—å—Ç–µ –≤—Ä–µ–º–µ–Ω–Ω–æ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ -->
        <div style="display: none;">ID –¥–æ–≥–æ–≤–æ—Ä–∞: {{ dogovor.id }}, Number: {{ dogovor.number }}</div>
        <!-- –ö–û–Ω–µ—Ü –æ—Ç–ª–∞–¥–∫–∏-->

        <tr {% if not dogovor.is_active %}class="table-secondary"{% endif %}>
          <td style="text-align: center;">
            <span class="badge bg-info text-dark">‚Ññ{{ dogovor.number }}</span>
          </td>
          <td style="text-align: center;">
            <strong>{{ dogovor.customer }}</strong>
            {% if dogovor.customer|length > 30 %}
            <br><small class="text-muted">{{ dogovor.customer|truncatechars:50 }}</small>
            {% endif %}
          </td>
          <td style="text-align: center;">
            {% if dogovor.date %}
              {{ dogovor.get_formatted_date }}
            {% else %}
              <span class="text-muted">–î–∞—Ç–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞</span>
            {% endif %}
          </td>
          <td style="text-align: center;">
            <span class="badge {% if dogovor.financing == 'own' %}bg-success{% else %}bg-warning{% endif %}">
              {{ dogovor.get_financing_display_name }}
            </span>
          </td>
          <td style="text-align: center;">
            <span class="badge {% if dogovor.longtime %}bg-primary{% else %}bg-secondary{% endif %}">
              {{ dogovor.get_longtime_display_name }}
            </span>
          </td>
          <td style="text-align: center;">
            {% if dogovor.is_active %}
              <span class="badge bg-success">–ê–∫—Ç–∏–≤–Ω—ã–π</span>
            {% else %}
              <span class="badge bg-danger">–ó–∞–≤–µ—Ä—à–µ–Ω</span>
            {% endif %}
          </td>
          <td style="text-align: center;">
            {% with objects_count=dogovor.object_set.count %}
              {% if objects_count > 0 %}
                <span class="badge bg-info">{{ objects_count }}</span>
              {% else %}
                <span class="badge bg-secondary">0</span>
              {% endif %}
            {% endwith %}
          </td>
          <td style="text-align: end;">
            <div class="btn-group btn-group" style="gap: 2px;">
            <!-- –ò—Å–ø–æ–ª—å–∑—É–µ–º data-–∞—Ç—Ä–∏–±—É—Ç—ã –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ -->
            <button onclick="showDogovorDetailsInline(this)" 
                    class="btn btn-info" 
                    title="–ü—Ä–æ—Å–º–æ—Ç—Ä"
                    data-id="{{ dogovor.id }}"
                    data-number="{{ dogovor.number }}"
                    data-customer="{{ dogovor.customer }}"
                    data-date="{{ dogovor.date|date:'d.m.Y' }}"
                    data-financing="{{ dogovor.get_financing_display_name }}"
                    data-longtime="{{ dogovor.get_longtime_display_name }}"
                    data-active="{{ dogovor.is_active }}"
                    data-created="{{ dogovor.created_at|date:'d.m.Y H:i' }}"
                    data-updated="{{ dogovor.updated_at|date:'d.m.Y H:i' }}">
                üëÅÔ∏è
            </button>

              {% if user.is_superuser %}
              <button onclick="loadModalForm('{% url 'dogovor_edit' pk=dogovor.id %}', '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–æ–≥–æ–≤–æ—Ä ‚Ññ{{ dogovor.number }}')" 
                class="btn btn-secondary" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                ‚úèÔ∏è
              </button>

              <button onclick="confirmDelete('{% url 'dogovor_delete' pk=dogovor.id %}', '‚Ññ{{ dogovor.number }}')" 
                class="btn btn-danger delete" title="–£–¥–∞–ª–∏—Ç—å">
                <strong>X</strong>
              </button>
              {% endif %}
            </div>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="8" style="text-align: center;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –¥–æ–≥–æ–≤–æ—Ä–∞—Ö</td>
        </tr>
        {% endfor %}
      </tbody>

      <!-- –°—Ç—Ä–æ–∫–∞ —Å —Å—É–º–º–æ–π -->
      <tr style="background-color: #f0f0f0; font-weight: bold;">
        <td colspan="6"></td>
        <td style="text-align: right; padding: 0px 10px;">
          –ò—Ç–æ–≥–æ: {{ dogovors|length }}
        </td>
        <td></td>
      </tr>
    </table>
  </div>
</div>


{% comment %} <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π –¥–æ–≥–æ–≤–æ—Ä–∞ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ) -->
<div class="modal fade" id="dogovorDetailsModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">–î–µ—Ç–∞–ª–∏ –¥–æ–≥–æ–≤–æ—Ä–∞</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="dogovorDetailsContent">
        <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–æ —á–µ—Ä–µ–∑ AJAX -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>
  </div>
</div> {% endcomment %}


<script>
// –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–µ—Ç–∞–ª–µ–π
function showDogovorDetailsInline(button) {
    const id = button.getAttribute('data-id');
    const number = button.getAttribute('data-number');
    const customer = button.getAttribute('data-customer');
    const date = button.getAttribute('data-date');
    const financing = button.getAttribute('data-financing');
    const longtime = button.getAttribute('data-longtime');
    const isActive = button.getAttribute('data-active') === 'True';
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
    const modalTitle = document.getElementById('modalTitle');
    if (modalTitle) {
        modalTitle.textContent = `–î–æ–≥–æ–≤–æ—Ä ‚Ññ${number}`;
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
    const modalFormContent = document.getElementById('modalFormContent');
    if (modalFormContent) {
        modalFormContent.innerHTML = `
            <div class="dogovor-details">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label"><strong>–ù–æ–º–µ—Ä –¥–æ–≥–æ–≤–æ—Ä–∞:</strong></label>
                            <div class="form-control-plaintext border rounded p-2 bg-light">${number}</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label"><strong>–ó–∞–∫–∞–∑—á–∏–∫:</strong></label>
                            <div class="form-control-plaintext border rounded p-2 bg-light">${customer}</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label"><strong>–î–∞—Ç–∞ –¥–æ–≥–æ–≤–æ—Ä–∞:</strong></label>
                            <div class="form-control-plaintext border rounded p-2 bg-light">${date || '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label"><strong>–§–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏–µ:</strong></label>
                            <div class="form-control-plaintext border rounded p-2 bg-light">${financing}</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label"><strong>–õ–æ–Ω–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:</strong></label>
                            <div class="form-control-plaintext border rounded p-2 bg-light">${longtime}</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label"><strong>–°—Ç–∞—Ç—É—Å:</strong></label>
                            <div class="form-control-plaintext border rounded p-2">
                                <span class="badge ${isActive ? 'bg-success' : 'bg-danger'}">
                                    ${isActive ? '–ê–∫—Ç–∏–≤–Ω—ã–π' : '–ó–∞–≤–µ—Ä—à–µ–Ω'}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="text-center mt-4">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
                        –ó–∞–∫—Ä—ã—Ç—å
                    </button>
                </div>
            </div>
        `;
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    const modal = bootstrap.Modal.getInstance(document.getElementById('objectModal')) || 
                  new bootstrap.Modal(document.getElementById('objectModal'));
    modal.show();
}


// –§—É–Ω–∫—Ü–∏—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è (–¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤ –æ—Å–Ω–æ–≤–Ω–æ–º JS)
function confirmDelete(url, name) {
    if (confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –¥–æ–≥–æ–≤–æ—Ä ${name}?`)) {
        fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            }
        })
        .catch(error => {
            alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error);
        });
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ CSRF —Ç–æ–∫–µ–Ω–∞
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ä–º—ã –≤ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ (–¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤ –æ—Å–Ω–æ–≤–Ω–æ–º JS)
function loadModalForm(url, title) {
    fetch(url)
        .then(response => response.text())
        .then(html => {
            const modalContainer = document.getElementById('modalContainer');
            if (modalContainer) {
                modalContainer.innerHTML = html;
                const modal = new bootstrap.Modal(document.getElementById('modalContainer').firstChild);
                modal.show();
                
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
                const form = document.getElementById('dogovorForm');
                if (form) {
                    form.addEventListener('submit', function(e) {
                        e.preventDefault();
                        const formData = new FormData(this);
                        
                        fetch(this.action, {
                            method: 'POST',
                            body: formData,
                            headers: {
                                'X-Requested-With': 'XMLHttpRequest'
                            }
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                modal.hide();
                                location.reload();
                            } else {
                                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫–∏
                                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏');
                            }
                        });
                    });
                }
            }
        })
        .catch(error => {
            alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ä–º—ã: ' + error);
        });
}


document.addEventListener('DOMContentLoaded', function() {
    console.log('–°—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–æ–≥–æ–≤–æ—Ä–æ–≤ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
    console.log('–í—Å–µ–≥–æ –¥–æ–≥–æ–≤–æ—Ä–æ–≤: {{ dogovors_count }}');
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥–æ–≥–æ–≤–æ—Ä–∞
    const addForm = document.getElementById('addDogovorForm');
    if (addForm) {
        addForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
            submitBtn.disabled = true;
            
            const formData = new FormData(this);
            
            fetch(this.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
                
                if (data.success) {
                    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                    const modal = bootstrap.Modal.getInstance(document.getElementById('addDogovorModal'));
                    if (modal) modal.hide();
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
                    showNotification('success', data.message || '–î–æ–≥–æ–≤–æ—Ä —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω');
                    
                    // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
                    addForm.reset();
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –¥–æ–≥–æ–≤–æ—Ä–æ–≤ (–ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã)
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                    
                } else {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫–∏
                    if (data.errors) {
                        let errorMessages = [];
                        for (const [field, error] of Object.entries(data.errors)) {
                            // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–æ–ª—è –≤ —á–∏—Ç–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç
                            const fieldNames = {
                                'number': '–ù–æ–º–µ—Ä –¥–æ–≥–æ–≤–æ—Ä–∞',
                                'customer': '–ó–∞–∫–∞–∑—á–∏–∫',
                                'date': '–î–∞—Ç–∞ –¥–æ–≥–æ–≤–æ—Ä–∞',
                                'financing': '–¢–∏–ø —Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏—è'
                            };
                            const fieldName = fieldNames[field] || field;
                            errorMessages.push(`${fieldName}: ${error}`);
                        }
                        showNotification('error', '–û—à–∏–±–∫–∏ –ø—Ä–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–∏ —Ñ–æ—Ä–º—ã:<br>' + errorMessages.join('<br>'));
                    } else {
                        showNotification('error', data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –¥–æ–≥–æ–≤–æ—Ä–∞');
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
                showNotification('error', '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.');
            });
        });
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    function showNotification(type, message) {
        // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        const notification = document.createElement('div');
        notification.className = `alert alert-${type} alert-dismissible fade show`;
        notification.style.position = 'fixed';
        notification.style.top = '20px';
        notification.style.right = '20px';
        notification.style.zIndex = '9999';
        notification.style.minWidth = '300px';
        notification.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(notification);
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 5000);
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});

</script>
{% comment %} {% endblock %} {% endcomment %}