{% load static %}

<style>
.accordion-arrow {
    transition: transform 0.2s ease;
    display: inline;
}

.accordion-arrow.rotated {
    transform: rotate(90deg) !important;
}

.customer-group-content {
    display: none;
    width: 100%;
}

.customer-group-content.expanded {
    display: table-row-group;
}

.customer-group-header {
    background-color: #eceff3ff !important;
    cursor: pointer;
}

.customer-group-header:hover {
    background-color: #e7ebefff !important;
}

.customer-group-header .accordion-arrow {
  display: inline-flex !important;
  align-items: center;
  justify-content: center;
}

/* Тени при раскрытии списков */
.customer-group-content {
    display: none;
    width: 100%;
    background-color: #f8f9fa;
    {% comment %} border-left: 3px solid #dee2e6; {% endcomment %}
    box-shadow: inset 0px 0px 10px 5px rgb(0 0 0 / 30%);
}

.customer-group-content.expanded {
    display: table-row-group;
}

.nested-content td:first-child {
    padding-left: 1vw !important;
}

.nested-content td {
    padding-left: 1vw !important;
    {% comment %} border-left: 1px solid #e9ecef; {% endcomment %}
}
</style>

<div class="card">
  <div class="card-header d-flex">
    <h3 style="margin: 0px; align-content: center;">Объекты ТО</h3>
    <div class="col d-flex justify-content-end align-items-center">

      <!-- Переключатель для управления всеми группами -->
      <div class="form-check form-switch me-3">
        <input class="form-check-input" type="checkbox" id="groupToggle" 
              onchange="toggleAllGroups(this.checked)">
        <label class="form-check-label" for="groupToggle">
          Группы
        </label>
      </div>

      {% comment %} <div class="form-check form-switch me-3">
        <input class="form-check-input" type="checkbox" id="sortToggle" 
              onclick="toggleSortMenu()">
        <label class="form-check-label" for="sortToggle">
          Сортировка
        </label>
      </div> {% endcomment %}

      {% if user.is_superuser %}
      <button type="button" class="btn btn-primary"
              onclick="loadModalForm('{% url 'object_add' %}', 'Добавить объект')">
        Добавить
      </button>
      {% endif %}
    </div>
  </div>

  {% load custom_filters %}

  <!-- Контейнер для меню сортировки (изначально скрыт) -->
  <div id="sortMenuContainer">
    {% include 'sort_object.html' %}
  </div>

  <div class="content-wrapper" id="mainContent">
  <div class="card-body" style="padding: 0px; min-height: 100px !important;">
    <table class="table-hover" style="width: 100%;">
      <tbody>

      <tr style="background-color: #de4c15; color: white;">
          {% comment %} <th>ID</th> {% endcomment %}
          <th class="delete" style="text-align: center;">Заказчик</th>
          <th style="text-align: center;">Адрес</th>
          <th style="text-align: center;">Телефон</th>
          <th></th>
      </tr>

      {% for group in grouped_objects %}
        {% if group.is_collapsed %}
        <!-- Свернутая группа в стиле аккордеона -->
        <tr class="customer-group-header accordion-header" 
            style="background-color: #e9ecef; cursor: pointer;"
            onclick="toggleCustomerGroup({{ forloop.counter }})"
            id="group-header-{{ forloop.counter }}"
            data-group-id="{{ forloop.counter }}">

          <td colspan="2" style="text-align: left; font-weight: bold; padding: 5px 10px;">
            {{ group.customer }}
          </td>

          {% comment %} <td></td> {% endcomment %}
          <td class="delete"></td>

          <td style="text-align: end; padding: 5px 15px; white-space: nowrap">
            <span class="badge" style="background-color: #de4c15;">{{ group.objects|length }} штук.</span>
              <span class="accordion-arrow"> 
                <svg width="16" height="16" viewBox="0 0 14 14" fill="none">
                  <path d="M6 4L10 8L6 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </span>
          </td>

        </tr>


          <!-- Содержимое группы (изначально скрыто) -->
          <tbody id="group-{{ forloop.counter }}" class="customer-group-content nested-content">

          {% for object in group.objects %}
              {% with service_record=service_records|get_item:object.id %}
              <tr style="background-color: 
              {% if service_record %}
                {% if service_record.result == 0 %} #00800030
                {% elif service_record.result == 1 %} #ffff0030
                {% elif service_record.result == 2 %} #ff000030
                {% else %} transparent
                {% endif %}
              {% else %} #80808063
              {% endif %};">

                  <td class="delete" style="text-align: left; padding-left: 2vw;">
                    <span style="opacity: 0.7;">↳</span> {{ object.customer }}
                  </td>

                  <td style="text-align: center; padding-left: 1vw;">
                    <a href="https://yandex.ru/maps/?text={{ object.address|urlencode }}" target="_blank" style="text-decoration: none; color: inherit;">
                      <img src="{% static 'ico/geo-alt.svg' %}" alt="phone" class="delete" style="width: 16px; height: 16px; vertical-align: middle;">
                        {{ object.address }}
                    </a>
                  </td>

                  <td style="text-align: center; padding: 0px 5px 0px 1vw;">
                    <a href="tel:{{ object.phone }}" style="text-decoration: none; color: inherit; text-wrap-mode: nowrap;">
                      <img src="{% static 'ico/telephone.svg' %}" alt="phone" class="delete" style="width: 16px; height: 16px; vertical-align: middle;">
                      {{ object.phone }}<br>
                    </a>
                  </td>

                  <td style="text-align: end; ">
                    <div class="btn-group" style="gap: 2px;">

                      {% if user.is_superuser %}
                      <button onclick="loadModalForm('{% url 'object_edit' pk=object.id %}', 'Редактировать объект')"
                              class="btn btn-secondary delete">&#9998;</button>
                      {% endif %}

                      <button onclick="loadModalForm('{% url 'avr_add' pk=object.id %}', 'Добавление АВР')"
                        class="btn btn-success">АВР</button>

                      <button class="btn btn-primary"
                        onclick="loadModalForm('{% url 'service_add' object_id=object.id %}', 'Добавление обслуживания', this)"
                        data-last-color="
                        {% if service_record %}
                          {% if service_record.result == 0 %}#d4edda
                          {% elif service_record.result == 1 %}#fff3cd
                          {% elif service_record.result == 2 %}#f8d7da
                          {% else %}#ffffff{% endif %}
                        {% else %}#808080{% endif %}">
                        ТО
                      </button>

                      {% if user.is_superuser %}
                      <button onclick="confirmDelete('{% url 'object_delete' pk=object.id %}', '{{ object.id }}')"
                              class="btn btn-danger delete" style="padding: 5px 15px;">
                        <strong>Х</strong>
                      </button>
                      {% endif %}

                    </div>
                  </td>

              </tr>
              {% endwith %}
            {% endfor %}
            </tbody>



        {% else %}

          <!-- Одиночный объект (без группировки) -->
          {% for object in group.objects %}
            {% with service_record=service_records|get_item:object.id %}
            <tr style="background-color:
            {% if service_record %}
              {% if service_record.result == 0 %} #00800050
              {% elif service_record.result == 1 %} #ffff0050
              {% elif service_record.result == 2 %} #ff000050
              {% else %} transparent
              {% endif %}
            {% else %} #80808063
            {% endif %};">

                <td class="delete" style="text-align: left; padding-left: 1vw;">{{ object.customer }}</td>
                <td style="text-align: center;">
                  <a href="https://yandex.ru/maps/?text={{ object.address|urlencode }}" target="_blank" style="text-decoration: none; color: inherit;">
                    <img src="{% static 'ico/geo-alt.svg' %}" alt="phone" class="delete" style="width: 16px; height: 16px; vertical-align: middle;">
                      {{ object.address }}
                  </a>
                </td>
                <td style="text-align: center; padding: 0px 5px 0px 5px;">
                  <a href="tel:{{ object.phone }}" style="text-decoration: none; color: inherit; text-wrap-mode: nowrap;">
                    <img src="{% static 'ico/telephone.svg' %}" alt="phone" class="delete" style="width: 16px; height: 16px; vertical-align: middle;">
                    {{ object.phone }}<br>
                  </a>
                </td>

                <td style="text-align: end;">
                  <div class="btn-group" style="gap: 2px;">

                    {% if user.is_superuser %}
                    <button onclick="loadModalForm('{% url 'object_edit' pk=object.id %}', 'Редактировать объект')" 
                            class="btn btn-secondary delete">&#9998;</button>
                    {% endif %}

                    <button onclick="loadModalForm('{% url 'avr_add' pk=object.id %}', 'Добавление АВР')" 
                      class="btn btn-success">АВР</button>

                    <button class="btn btn-primary" 
                      onclick="loadModalForm('{% url 'service_add' object_id=object.id %}', 'Добавление обслуживания', this)" 
                      data-last-color="
                      {% if service_record %}
                        {% if service_record.result == 0 %}#d4edda
                        {% elif service_record.result == 1 %}#fff3cd
                        {% elif service_record.result == 2 %}#f8d7da
                        {% else %}#ffffff{% endif %}
                      {% else %}#808080{% endif %}">
                      ТО
                    </button>

                    {% if user.is_superuser %}
                    <button onclick="confirmDelete('{% url 'object_delete' pk=object.id %}', '{{ object.id }}')" 
                            class="btn btn-danger delete" style="padding: 5px 15px;">
                      <strong>Х</strong>
                    </button>
                    {% endif %}

                  </div>
                </td>
            </tr>
            {% endwith %}
          {% endfor %}


        {% endif %}
      {% empty %}


          <tr>
          <td colspan="4" style="text-align: center; padding: 20px;">
              {% if user.is_superuser %}
                  Нет объектов для отображения
              {% else %}
                  У вас нет доступа к объектам или объекты не назначены
              {% endif %}
          </td>
        </tr>

      {% endfor %}

      <!-- Строка с суммой -->
      <tr style="background-color: #f0f0f0; font-weight: bold;">
        <td colspan="2"></td>
        <td style="text-align: right; padding: 0px 10px;">
          Итого: {{ objects|length }}
        </td>
        <td class="delete"></td>
      </tr>
    </tbody>
    </table>
  </div>
  </div>
</div>

<script>
// Функция разворачивания группы
function expandGroup(groupContent, arrow) {
    groupContent.classList.add('expanded');
    arrow.classList.add('rotated');
}

// Функция сворачивания группы
function collapseGroup(groupContent, arrow) {
    groupContent.classList.remove('expanded');
    arrow.classList.remove('rotated');
}

// Упрощенная функция переключения группы
function toggleCustomerGroup(groupId) {
    const groupContent = document.getElementById(`group-${groupId}`);
    const arrow = document.querySelector(`[data-group-id="${groupId}"] .accordion-arrow`);
    
    groupContent.classList.toggle('expanded');
    arrow.classList.toggle('rotated');
}

// Упрощенная функция управления всеми группами
function toggleAllGroups(isChecked) {
    document.querySelectorAll('.customer-group-content').forEach(content => {
        const arrow = content.previousElementSibling.querySelector('.accordion-arrow');
        if (isChecked) {
            content.classList.add('expanded');
            arrow.classList.add('rotated');
        } else {
            content.classList.remove('expanded');
            arrow.classList.remove('rotated');
        }
    });
}

// Инициализация состояния при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    const groupToggle = document.getElementById('groupToggle');
    if (groupToggle) {
        groupToggle.checked = false;
    }
    // Убедимся, что все группы изначально свернуты
    document.querySelectorAll('.customer-group-content').forEach(content => {
        content.classList.remove('expanded');
    });
});
</script>

<script src={% static 'js/object.js' %}></script>