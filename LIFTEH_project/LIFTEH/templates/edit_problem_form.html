<!-- templates/edit_problem_form.html -->
<form method="post" action="{% url 'edit_problem' problem.id %}" id="editProblemForm">
    {% csrf_token %}
    <input type="hidden" name="problem_id" value="{{ problem.id }}">
    
    <div class="form-floating mb-3">
        <input type="text" class="form-control" id="editProblemName" name="name" 
               value="{{ problem.name }}" placeholder="Введите задачу" required maxlength="200">
        <label for="editProblemName">Наименование задачи</label>
        <div class="invalid-feedback">Пожалуйста, введите название задачи</div>
    </div>
    
    <div class="form-floating mb-3">
        <input type="date" class="form-control" id="editProblemDate" name="created_date" 
               value="{{ problem.created_date|date:'Y-m-d' }}" required>
        <label for="editProblemDate">Дата создания</label>
        <div class="invalid-feedback">Пожалуйста, выберите дату</div>
    </div>
    
    <div class="d-flex justify-content-end">
        <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Отмена</button>
        <button type="submit" class="btn btn-primary" id="submitEditBtn">Сохранить</button>
    </div>
</form>

<script>
// Функция валидации формы редактирования
function validateEditProblemForm() {
    const nameInput = document.getElementById('editProblemName');
    const dateInput = document.getElementById('editProblemDate');
    const isValid = nameInput.value.trim().length > 0 && dateInput.value;
    
    if (isValid) {
        nameInput.classList.remove('is-invalid');
        nameInput.classList.add('is-valid');
        dateInput.classList.remove('is-invalid');
        dateInput.classList.add('is-valid');
    } else {
        if (nameInput.value.trim().length === 0) {
            nameInput.classList.remove('is-valid');
            nameInput.classList.add('is-invalid');
        }
        if (!dateInput.value) {
            dateInput.classList.remove('is-valid');
            dateInput.classList.add('is-invalid');
        }
    }
    
    return isValid;
}

// Обработчик отправки формы редактирования
document.getElementById('editProblemForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    if (!validateEditProblemForm()) {
        alert('Пожалуйста, заполните все поля правильно');
        return false;
    }
    
    const form = e.target;
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Сохранение...';
    submitBtn.disabled = true;
    
    const formData = new FormData(form);
    
    console.log('Submitting edit form to:', form.action);
    console.log('Form data:', Object.fromEntries(formData.entries()));
    
    fetch(form.action, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': form.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => {
        console.log('Response status:', response.status);
        if (!response.ok) {
            throw new Error('Network response was not ok: ' + response.status);
        }
        return response.json();
    })
    .then(data => {
        console.log('Response data:', data);
        if (data.success) {
            // Закрываем модальное окно
            const modal = bootstrap.Modal.getInstance(document.getElementById('objectModal'));
            if (modal) {
                modal.hide();
            }
            // Обновляем страницу
            window.location.reload();
        } else {
            alert('Ошибка: ' + (data.error || 'Неизвестная ошибка'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Ошибка при сохранении изменений: ' + error.message);
    })
    .finally(() => {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
    
    return false;
});

// Инициализация валидации при загрузке
document.addEventListener('DOMContentLoaded', function() {
    validateEditProblemForm();
});
</script>