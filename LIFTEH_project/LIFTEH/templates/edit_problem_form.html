<!-- templates/edit_problem_form.html -->
<form method="post" action="{% url 'edit_problem' problem.id %}" id="editProblemForm">
    {% csrf_token %}
    <input type="hidden" name="problem_id" value="{{ problem.id }}">

    <div class="form-floating mb-3">
        <input type="text" class="form-control" id="editProblemName" name="name"
               value="{{ problem.name }}" placeholder="–í–≤–µ–¥–∏—Ç–µ –∑–∞–¥–∞—á—É" required maxlength="200">
        <label for="editProblemName">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏</label>
        <div class="invalid-feedback">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏</div>
    </div>

    <div class="form-floating mb-3">
        <input type="date" class="form-control" id="editProblemDate" name="created_date"
               value="{{ problem.created_date|date:'Y-m-d' }}" required>
        <label for="editProblemDate">–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</label>
        <div class="invalid-feedback">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É</div>
    </div>

    <!-- –ü–æ–ª–µ –≤—ã–±–æ—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Ç–æ–ª—å–∫–æ –¥–ª—è —Å—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π) -->
    {% if user.is_superuser %}
    <div class="mb-3">
        <label for="editProblemUser" class="form-label">–ù–∞–∑–Ω–∞—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é</label>
        <select class="form-select" id="editProblemUser" name="user_id">
            <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è --</option>
            {% for user_obj in users %}
            <option value="{{ user_obj.id }}" {% if user_obj.id == problem.user.id %}selected{% endif %}>
                {{ user_obj.username }}
                {% if user_obj.first_name or user_obj.last_name %}
                ({{ user_obj.first_name }} {{ user_obj.last_name }})
                {% endif %}
                {% if user_obj.is_superuser %}üëë{% endif %}
            </option>
            {% endfor %}
        </select>
        <div class="form-text">–¢–æ–ª—å–∫–æ —Å—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç –∏–∑–º–µ–Ω—è—Ç—å –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –∑–∞–¥–∞—á</div>
    </div>
    {% else %}
    <input type="hidden" name="user_id" value="{{ problem.user.id }}">
    <div class="alert alert-info">
        <small>–ó–∞–¥–∞—á–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∞: <strong>{{ problem.user.username }}</strong></small>
    </div>
    {% endif %}

    <div class="d-flex justify-content-end">
        <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
        <button type="submit" class="btn btn-primary" id="submitEditBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
</form>

<script>
// –§—É–Ω–∫—Ü–∏—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ñ–æ—Ä–º—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
function validateEditProblemForm() {
    const nameInput = document.getElementById('editProblemName');
    const dateInput = document.getElementById('editProblemDate');
    const userSelect = document.getElementById('editProblemUser');

    let isValid = nameInput.value.trim().length > 0 && dateInput.value;

    // –ï—Å–ª–∏ –µ—Å—Ç—å –ø–æ–ª–µ –≤—ã–±–æ—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–¥–ª—è —Å—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π), –ø—Ä–æ–≤–µ—Ä—è–µ–º –µ–≥–æ
    if (userSelect) {
        isValid = isValid && userSelect.value !== '';
    }

    // –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞–∑–≤–∞–Ω–∏—è
    if (nameInput.value.trim().length > 0) {
        nameInput.classList.remove('is-invalid');
        nameInput.classList.add('is-valid');
    } else {
        nameInput.classList.remove('is-valid');
        nameInput.classList.add('is-invalid');
    }

    // –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞—Ç—ã
    if (dateInput.value) {
        dateInput.classList.remove('is-invalid');
        dateInput.classList.add('is-valid');
    } else {
        dateInput.classList.remove('is-valid');
        dateInput.classList.add('is-invalid');
    }

    // –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Ç–æ–ª—å–∫–æ –¥–ª—è —Å—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
    if (userSelect) {
        if (userSelect.value !== '') {
            userSelect.classList.remove('is-invalid');
            userSelect.classList.add('is-valid');
        } else {
            userSelect.classList.remove('is-valid');
            userSelect.classList.add('is-invalid');
        }
    }
    return isValid;
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
document.getElementById('editProblemForm').addEventListener('submit', function(e) {
    e.preventDefault();

    if (!validateEditProblemForm()) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ');
        return false;
    }

    const form = e.target;
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
    submitBtn.disabled = true;

    const formData = new FormData(form);

    fetch(form.action, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': form.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok: ' + response.status);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            const modal = bootstrap.Modal.getInstance(document.getElementById('objectModal'));
            if (modal) {
                modal.hide();
            }
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
            window.location.reload();
        } else {
            alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π: ' + error.message);
    })
    .finally(() => {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
    return false;
});

// –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–æ–ª–µ–π
document.addEventListener('DOMContentLoaded', function() {
    const nameInput = document.getElementById('editProblemName');
    const dateInput = document.getElementById('editProblemDate');
    const userSelect = document.getElementById('editProblemUser');
    if (nameInput) {
        nameInput.addEventListener('input', validateEditProblemForm);
        nameInput.addEventListener('blur', validateEditProblemForm);
    }
    if (dateInput) {
        dateInput.addEventListener('change', validateEditProblemForm);
        dateInput.addEventListener('blur', validateEditProblemForm);
    }
    if (userSelect) {
        userSelect.addEventListener('change', validateEditProblemForm);
        userSelect.addEventListener('blur', validateEditProblemForm);
    }
    validateEditProblemForm();
});
</script>