<!-- templates/problems_table.html -->
<table class="table table-hover table-sm" style="width: 100%; margin-bottom: 0px;">
    <thead class="table-light">
        <tr>
            <th class="delete" style="width: 5%; text-align: center; background-color: #de4c15; color: white;">№</th>
            <th style="width: 100%; text-align: left; background-color: #de4c15; color: white; padding: 0px 5px;">Задача</th>
            <th class="delete" style="width: 10%; text-align: center; background-color: #de4c15; color: white;">Создано</th>
            {% if user.is_superuser %}
            <th style="width: 10%; text-align: center; background-color: #de4c15; color: white;"></th>
            {% endif %}
            <th class="delete" style="width: 10%; background-color: #de4c15; color: white;"></th>
        </tr>
    </thead>
    <tbody>
        {% for problem in problems %}
        <tr id="problem-row-{{ problem.id }}">
            <td class="delete" style="text-align: center; align-content: center;">
                <strong>{{ problem.id }}</strong></td>
            <td style="align-content: center; padding: 5px;" id="problem-name-{{ problem.id }}">
                {{ problem.name }}</td>
            <td class="delete" style="text-align: center; align-content: center; padding: 5px;" id="problem-date-{{ problem.id }}">
                {{ problem.created_date|date:"d.m.Y" }}</td>
            {% if user.is_superuser %}
            <td class="delete" style="text-align: center; align-content: center; padding: 5px;">
                <small class="text-muted">{{ problem.user.username }}</small></td>
            {% endif %}
            <td class="text-end" style="width: 10%; text-wrap: nowrap; align-content: center;">

              <div class="btn-group" style="gap: 2px;">
                {% if user.is_superuser or problem.user == user %}
                <button class="btn btn-secondary edit-btn" style="padding: 5px 10px;"
                        data-id="{{ problem.id }}"
                        data-name="{{ problem.name }}"
                        data-date="{{ problem.created_date|date:'Y-m-d' }}">
                    &#9998;
                </button>

                <button onclick="confirmDelete('{% url 'delete_problem' problem_id=problem.id %}', {{ problem.id }})"
                        class="btn btn-danger" 
                        type="button"
                        style="padding: 5px 15px;"
                        data-id="{{ problem.id }}"
                        data-name="{{ problem.name }}">
                    <strong>Х</strong>
                </button>

                {% else %}
                {% comment %} <span class="text-muted small">для {{ problem.user.username }}</span> {% endcomment %}
                {% endif %}
              </div>

            </td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="{% if user.is_superuser %}6{% else %}5{% endif %}" class="text-center">
                {% if user.is_superuser %}
                    Нет задач
                {% else %}
                    У вас нет задач
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </tbody>

    <tr style="background-color: #f0f0f0; font-weight: bold;">
        {% comment %} <td colspan="{% if user.is_superuser %}3{% else %}2{% endif %}" style="text-align: right;">Итого:</td> {% endcomment %}
        <td class="delete"></td>
        <td style="text-align: right;">Итого:</td>
        <td style="text-align: left; padding: 0px 10px; align-content: center;">
            {{ problems|length }}
        </td>
        {% if user.is_superuser %}
        <td class="delete"></td>
        {% endif %}
        <td class="delete"></td>
    </tr>
</table>

<script>
// Функция для загрузки формы редактирования
function loadEditProblemForm(problemId, problemName, problemDate) {
    const modal = new bootstrap.Modal(document.getElementById('objectModal'));
    document.getElementById('modalTitle').textContent = 'Редактировать задачу';

    // Очищаем предыдущее содержимое
    document.getElementById('modalFormContent').innerHTML =
        '<div class="text-center py-4"><div class="spinner-border" role="status"><span class="visually-hidden">Загрузка...</span></div></div>';
    // Показываем модальное окно сразу
    modal.show();

    fetch(`/problems/${problemId}/edit/`, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'text/html'
        }
    })
    .then(response => {
        if (!response.ok) {
            if (response.status === 403) {
                throw new Error('У вас нет прав для редактирования этой задачи');
            }
            throw new Error(`Network response was not ok: ${response.status} ${response.statusText}`);
        }
        return response.text();
    })
    .then(html => {
        document.getElementById('modalFormContent').innerHTML = html;
    })
    .catch(error => {
        console.error('Error loading edit form:', error);
        document.getElementById('modalFormContent').innerHTML =
            '<div class="alert alert-danger">Ошибка загрузки формы редактирования: ' + error.message + '</div>';
    });
}


// Функция для удаления проблемы
function deleteProblem(problemId, problemName) {
    if (!confirm(`Вы уверены, что хотите удалить задачу "${problemName}"?`)) {
        return;
    }

    const deleteBtn = document.querySelector(`.delete-btn[data-id="${problemId}"]`);
    const originalHtml = deleteBtn.innerHTML;
    deleteBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span>';
    deleteBtn.disabled = true;

    fetch(`/problems/${problemId}/delete/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}',
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        if (!response.ok) {
            if (response.status === 403) {
                throw new Error('У вас нет прав для удаления этой задачи');
            }
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // Удаляем строку из таблицы
            const row = document.getElementById(`problem-row-${problemId}`);
            if (row) {
                row.remove();
                updateProblemsCount();// Обновляем счетчик
            }
            // Показываем уведомление об успехе
            showNotification('Задача удалена', 'success');
        } else {
            throw new Error(data.error || 'Неизвестная ошибка');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Ошибка при удалении задачи: ' + error.message);
    })
    .finally(() => {
        deleteBtn.innerHTML = originalHtml;
        deleteBtn.disabled = false;
    });
}


// Функция для обновления счетчика задач
function updateProblemsCount() {
    const rows = document.querySelectorAll('tbody tr:not([style*="display: none"])');
    const countElement = document.querySelector('tr[style*="background-color: #f0f0f0"] td:nth-child(2)');
    if (countElement) {
        countElement.textContent = rows.length;
    }
}

// Функция для показа уведомлений
function showNotification(message, type = 'success') {
    // Создаем элемент уведомления
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} alert-dismissible fade show`;
    notification.style.position = 'fixed';
    notification.style.top = '20px';
    notification.style.right = '20px';
    notification.style.zIndex = '9999';
    notification.style.minWidth = '300px';
    notification.innerHTML = `${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;

    document.body.appendChild(notification);

    // Автоматически скрываем через 3 секунды
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 3000);
}


// Обработчики событий после загрузки DOM
document.addEventListener('DOMContentLoaded', function() {
    // Обработчики для кнопок редактирования
    document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const problemId = this.getAttribute('data-id');
            const problemName = this.getAttribute('data-name');
            const problemDate = this.getAttribute('data-date');
            loadEditProblemForm(problemId, problemName, problemDate);
        });
    });

    // Обработчики для кнопок удаления
    document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const problemId = this.getAttribute('data-id');
            const problemName = this.getAttribute('data-name');
            deleteProblem(problemId, problemName);
        });
    });
});

// Функция для перепривязки обработчиков после AJAX обновлений
function attachProblemEventHandlers() {
    document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const problemId = this.getAttribute('data-id');
            const problemName = this.getAttribute('data-name');
            const problemDate = this.getAttribute('data-date');
            loadEditProblemForm(problemId, problemName, problemDate);
        });
    });
    
    document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const problemId = this.getAttribute('data-id');
            const problemName = this.getAttribute('data-name');
            deleteProblem(problemId, problemName);
        });
    });
}
</script>