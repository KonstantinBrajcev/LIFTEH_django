name: Django CD
on:
  push:
    branches: [main]
jobs:
  deploy:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verify settings.py exists
        working-directory: ./LIFTEH_project
        run: |
          if [ ! -f "settings.py" ]; then
            echo "::error::settings.py not found in repository!"
            exit 1
          fi
          echo "settings.py found and valid"

      - name: Set up Python 3.8
        uses: actions/setup-python@v5
        with:
          python-version: "3.8"

      - name: Install dependencies
        working-directory: ./LIFTEH_project
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-server.txt

      # - name: Copy project to server
      #   uses: appleboy/scp-action@v1
      #   with:
      #     host: ${{ secrets.SSH_HOST }}
      #     username: ${{ secrets.SSH_USERNAME }}
      #     key: ${{ secrets.SSH_PRIVATE_KEY }}
      #     source: "LIFTEH_project/"
      #     target: "${{ secrets.PROJECT_PATH }}"
      #     overwrite: true

      # –î–û–ë–ê–í–¨–¢–ï –≠–¢–û–¢ –®–ê–ì –î–õ–Ø –û–¢–õ–ê–î–ö–ò –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–Ø SSH
      - name: Test SSH connection
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "‚úÖ SSH –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ"
            echo "–¢–µ–∫—É—â–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $(pwd)"
            echo "–¶–µ–ª–µ–≤–æ–π –ø—É—Ç—å: ${{ secrets.PROJECT_PATH }}"
            echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –ø—É—Ç–∏:"
            if [ -d "${{ secrets.PROJECT_PATH }}" ]; then
              echo "‚úÖ –¶–µ–ª–µ–≤–æ–π –ø—É—Ç—å —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
              ls -la "${{ secrets.PROJECT_PATH }}"
            else
              echo "‚ö†Ô∏è –¶–µ–ª–µ–≤–æ–π –ø—É—Ç—å –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω"
            fi

      # –û–ë–ù–û–í–õ–ï–ù–ù–´–ô –®–ê–ì –ö–û–ü–ò–†–û–í–ê–ù–ò–Ø –° –û–¢–õ–ê–î–ö–û–ô
      - name: Copy project to server
        uses: appleboy/scp-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "LIFTEH_project/"
          target: "${{ secrets.PROJECT_PATH }}"
          overwrite: true
          strip_components: 0
          debug: true # –í–∫–ª—é—á–∞–µ–º –æ—Ç–ª–∞–¥–∫—É SCP
          timeout: 60s # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ç–∞–π–º–∞—É—Ç

      - name: Verify copied files
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤:"
            cd "${{ secrets.PROJECT_PATH }}"
            echo "–¢–µ–∫—É—â–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $(pwd)"
            echo "–°–æ–¥–µ—Ä–∂–∏–º–æ–µ LIFTEH_project:"
            ls -la LIFTEH_project/ 2>/dev/null || echo "–ü–∞–ø–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
            echo "–ù–∞–ª–∏—á–∏–µ settings.py:"
            find . -name "settings.py" -type f | head -5

      - name: Prepare server (migrations + static)
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd "${{ secrets.PROJECT_PATH }}/LIFTEH_project"
            source ~/myenv/bin/activate
            export DJANGO_PRODUCTION=true
            export DJANGO_SETTINGS_MODULE=settings

            # –ë—ã—Å—Ç—Ä–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
            pip install -r requirements-server.txt -q
            python manage.py migrate --no-input
            python manage.py collectstatic --noinput -v 0

            echo "‚úÖ –°–µ—Ä–≤–µ—Ä –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω"
            echo "üìÅ –°—Ç–∞—Ç–∏–∫–∞: $(du -sh staticfiles/ | cut -f1)"

      - name: Restart Gunicorn
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            source ~/myenv/bin/activate
            cd ${{ secrets.PROJECT_PATH }}/LIFTEH_project || exit 1
            export DJANGO_PRODUCTION=true
            export DJANGO_SETTINGS_MODULE=settings

            # –í–∞—à–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è –ª–æ–≥–∏–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
            PIDS=$(pgrep -f gunicorn)
            MY_PID=$$
            MY_PPID=$(ps -o ppid= -p $$ | tr -d ' ')
            if [ -n "$PIDS" ]; then
              for pid in $PIDS; do
                if [ "$pid" = "$MY_PID" ] || [ "$pid" = "$MY_PPID" ]; then
                  continue
                fi
                kill "$pid" 2>/dev/null || echo "–ü—Ä–æ—Ü–µ—Å—Å $pid —É–∂–µ –∑–∞–≤–µ—Ä—à—ë–Ω"
              done
              sleep 2
            fi

            # –ó–∞–ø—É—Å–∫–∞–µ–º –≤ –ø–æ–¥–ø—Ä–æ—Ü–µ—Å—Å–µ —Å –ø–æ–ª–Ω—ã–º –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ–º
            (nohup gunicorn --bind 0.0.0.0:8001 --workers 3 --timeout 120 LIFTEH_project.wsgi:application > gunicorn.log 2>&1 &)

            sleep 5  # ‚¨ÖÔ∏è –£–í–ï–õ–ò–ß–¨–¢–ï –¢–ê–ô–ú–ê–£–¢ –î–û 5 –°–ï–ö–£–ù–î

            # –ë–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
            echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø—É—Å–∫–∞ Gunicorn:"
            if pgrep -f "gunicorn.*LIFTEH_project" > /dev/null; then
              echo "‚úÖ Gunicorn —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω"
              echo "–ê–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã:"
              pgrep -af gunicorn
            else
              echo "‚ùå Gunicorn –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è"
              echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:"
              tail -10 gunicorn.log 2>/dev/null || echo "–õ–æ–≥–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã"
            fi

      - name: Verify static files
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd "${{ secrets.PROJECT_PATH }}/LIFTEH_project"
            echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤:"
            if [ -d "staticfiles" ]; then
              find staticfiles/ -type f -name "*.css" -o -name "*.js" | head -10
              echo "–†–∞–∑–º–µ—Ä –ø–∞–ø–∫–∏ staticfiles:"
              du -sh staticfiles/
            else
              echo "‚ùå –ü–∞–ø–∫–∞ staticfiles –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!"
              echo "–°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ç–µ–∫—É—â–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏:"
              ls -la
            fi
